<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>eda_sql</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="eda_sql_files/libs/clipboard/clipboard.min.js"></script>
<script src="eda_sql_files/libs/quarto-html/quarto.js"></script>
<script src="eda_sql_files/libs/quarto-html/popper.min.js"></script>
<script src="eda_sql_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="eda_sql_files/libs/quarto-html/anchor.min.js"></script>
<link href="eda_sql_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="eda_sql_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="eda_sql_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="eda_sql_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="eda_sql_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="eda_sql_files/libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="eda_sql_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="eda_sql_files/libs/datatables-binding-0.20/datatables.js"></script>
<script src="eda_sql_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="eda_sql_files/libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="eda_sql_files/libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="eda_sql_files/libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="eda_sql_files/libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="eda_sql_files/libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#analysing-train-service-data" id="toc-analysing-train-service-data" class="nav-link active" data-scroll-target="#analysing-train-service-data">Analysing train service data</a>
  <ul class="collapse">
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link" data-scroll-target="#executive-summary">Executive summary</a></li>
  <li><a href="#database-structure" id="toc-database-structure" class="nav-link" data-scroll-target="#database-structure">Database structure</a></li>
  <li><a href="#exploratory-data-analysis-with-sql" id="toc-exploratory-data-analysis-with-sql" class="nav-link" data-scroll-target="#exploratory-data-analysis-with-sql">Exploratory data analysis with SQL</a>
  <ul class="collapse">
  <li><a href="#connecting-to-local-database" id="toc-connecting-to-local-database" class="nav-link" data-scroll-target="#connecting-to-local-database">Connecting to local database</a></li>
  <li><a href="#a-first-dive-into-the-data" id="toc-a-first-dive-into-the-data" class="nav-link" data-scroll-target="#a-first-dive-into-the-data">A first dive into the data</a></li>
  <li><a href="#delays-distribution" id="toc-delays-distribution" class="nav-link" data-scroll-target="#delays-distribution">Delays distribution</a></li>
  <li><a href="#main-metrics-by-time-periods" id="toc-main-metrics-by-time-periods" class="nav-link" data-scroll-target="#main-metrics-by-time-periods">Main metrics by time periods</a></li>
  <li><a href="#main-metrics-by-train-line" id="toc-main-metrics-by-train-line" class="nav-link" data-scroll-target="#main-metrics-by-train-line">Main metrics by train line</a></li>
  <li><a href="#delay-by-journey-time" id="toc-delay-by-journey-time" class="nav-link" data-scroll-target="#delay-by-journey-time">Delay by journey time</a></li>
  <li><a href="#delay-by-number-of-stops" id="toc-delay-by-number-of-stops" class="nav-link" data-scroll-target="#delay-by-number-of-stops">Delay by number of stops</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">



<section id="analysing-train-service-data" class="level1">
<h1>Analysing train service data</h1>
<p>The data that will be used for this preliminary analysis contains relevant information about Catalan railway system operation, such as train schedules or tracking data about commuter and regional trains run by RENFE in Catalonia. Therefore, this data excludes high-speed trains and other railway service providers like FGC.</p>
<p>The present data have been previously scraped automatically employing a self-written R script and deployed and automated using GitHubâ€™s CLI service GitHub Actions. In a first stage, the data has been stored in a cloud-based PostgreSQL database. After that, the scraped data has been preprocessed to make it suitable for the final data model and stored in a local PostgreSQL relational database.</p>
<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive summary</h2>
<ul>
<li><p>In the analyzed period, 53% of the trains arrived late at their destinations. However, this figure hides substantial differences between commuter (55.9%) and regional trains (31.9%).</p></li>
<li><p>Most unpunctual trains experienced minor to moderate delays, just slightly over the threshold to be considered unpunctual. Given that, small improvements to the railway service or its infrastructure could potentially yield major improvements in punctuality metrics.</p></li>
<li><p>Most delays are observed between rush hours, mainly on weekdays, suggesting that a large part of them could be caused by small dysfunctions causing multiplicative effects on a congested infrastructure.</p></li>
<li><p>Trains with lower journey times and/or fewer stops experience fewer delays and better punctuality metrics. Given that, shorter services with coordinated or cadenced schedules could be a better approach, especially for those lines covering greater distances.</p></li>
</ul>
</section>
<section id="database-structure" class="level2">
<h2 class="anchored" data-anchor-id="database-structure">Database structure</h2>
<p>As seen below, the database that will be used contains 5 relational tables conforming a star schema. These tables include basic train data, schedule and tracking data for every scraped train as well as complementary information contained in stations and date tables.</p>
<p><img src="images/data_model-02.png" class="img-fluid"></p>
<p>Train data table includes, among others:</p>
<ul>
<li><p><strong>id_key</strong>: composed unique key for every scraped train, obtained by concatenating the date_key value and the technical and commercial train ids.</p></li>
<li><p><strong>line</strong>: train service line.</p></li>
<li><p><strong>actual_origin_code</strong> and <strong>actual_destination_code</strong>: train departure station and train final station numeric codes.</p></li>
<li><p><strong>actual_origin_departure_time</strong> and <strong>actual_destination_arrival_time</strong>: real departure/arrival time at origin and destination station.</p></li>
<li><p><strong>last_stop_code</strong>: last station where the train have stopped, usually the last scheduled stop or null (in both cases meaning that train have arrived at the scheduled destination station)</p></li>
<li><p><strong>last_stop_delay</strong>: train delay at destination or, otherwise, at the last station where it has stopped.</p></li>
<li><p><strong>is_pmr</strong>: train accessibility for people with mobility issues. If true train have features to allow easy on-boarding (train floor at platform level and/or ramps)</p></li>
<li><p><strong>is_disabled</strong>: if true train have been cancelled.</p></li>
<li><p><strong>is_cancelled</strong>: on practice indistinguishable from is_disabled. If true, train has been cancelled.</p></li>
<li><p><strong>data_timestamp</strong>: date and hour indicating when the data was scraped (CEST time).</p></li>
</ul>
<p>Train schedule table includes:</p>
<ul>
<li><p><strong>stop_code</strong>: station code for every station where a given train stops.</p></li>
<li><p><strong>stop_arrival_time</strong> and <strong>stop_departure_time</strong>: arrival and departure time for every scheduled stop.</p></li>
<li><p><strong>stop_order</strong>: given order in which train stops on every station, according to schedule.</p></li>
<li><p><strong>schedule_timestamp</strong>: date and hour indicating when the schedule data was scraped (CEST time).</p></li>
</ul>
<p>Tracking data includes:</p>
<ul>
<li><p><strong>next_stop_code</strong>: next scheduled stop at the moment when tracking data was scraped, indicating that the train is going to a given station or already arrived but it hasnâ€™t departed from.</p></li>
<li><p><strong>current_delay</strong>: estimated train delay in minutes at the scraping time and according the scheduled time for the next scheduled stop. Can take positive (train is delayed) or negative values (train going ahead of schedule).</p></li>
<li><p><strong>obtained_at</strong>:date and hour indicating when the tracking data was obtained (CEST time).</p></li>
</ul>
</section>
<section id="exploratory-data-analysis-with-sql" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis-with-sql">Exploratory data analysis with SQL</h2>
<p>Although there are other companies providing railway services in Catalonia, Renfe is undoubtedly the largest. This public company, held by the Spanish state, operates in Catalonia a rail network that extends for more than 460 km, covering the densely populated Barcelona area (4.5M inhabitants) as well as other significant cities and towns and part of the Catalan countryside. Given that some rides end at â€˜Cervera de la Marendaâ€™ and â€˜La Tor de Querolâ€™ stations, in French territory, RENFE trains also provide valuable international connections with the French commuter and regional trains run by its homologue SNCF.</p>
<p>For years Renfeâ€™s service, which serves about 350,000 daily rides on weekdays, has been refered to be very poor, unpunctual, and unreliable. The lack of public investment by the central Spanish government has usually been pointed out as the main reason for these deficiencies.</p>
<p>To test these feelings about Renfeâ€™s service in Catalonia I will take a first glance at the scraped data. More precisely, the data that I will be analysing here takes into account the first 75 days of available data, from mid-August to the end of October 2022. For this preliminary analysis, I will be using PostgreSQL syntax to query data directly from the database. Later, in a more advanced stage, I will use R language for data cleaning and provide a more in-depth analysis.</p>
<section id="connecting-to-local-database" class="level3">
<h3 class="anchored" data-anchor-id="connecting-to-local-database">Connecting to local database</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RPostgres)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(DT)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># PostgreSQL local database connection</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(), </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dbname =</span> <span class="st">"traindb"</span>, </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">host =</span> <span class="st">"localhost"</span>, </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">port =</span> <span class="st">"5432"</span>, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">user =</span> <span class="fu">Sys.getenv</span>(<span class="st">"TRAIN_LOCALDB_USER"</span>), </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">"TRAIN_LOCALPWD"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-first-dive-into-the-data" class="level3">
<h3 class="anchored" data-anchor-id="a-first-dive-into-the-data">A first dive into the data</h3>
<p>To start with, Iâ€™ll be creating a temporary table called â€˜basic_dataâ€™ to hold all those basic variables Iâ€™ll be looking in all along the analysis. Therefore, some joins between tables will be needed. For now, Iâ€™ll only be using train_data table along with the two tables holding date and stations data. As schedule and tracking tables will need a more in depth review and cleaning to be truly useful, Iâ€™ll let those for a later, more in depth EDA with R.</p>
<p>This said, in this first stage Iâ€™ll be adding three new measures using the existing data:</p>
<ul>
<li><p><strong>service_type</strong>, which according to which train line a train is assigned will classify them as â€˜Commuterâ€™ or â€˜Regionalâ€™.</p></li>
<li><p><strong>is_delay</strong>, which taking the observed delay at the end of the journey and the service type will assign a boolean true/false value. More than 3 minutes delay at destination is considered the threshold for commuter trains, which goes up to 5 minutes for regional trains. The criterion used to establish which trains are effectively considered delayed or not is the same as that used by Renfe [<a href="https://rodalies.gencat.cat/ca/sobre-rodalies/que-son-rodalies-de-catalunya/index.html">See here</a>]</p></li>
<li><p><strong>is_cancelled</strong>, recoded measure as itâ€™s distinguishable from is_disabled. When is_disabled is true, is_cancelled also turns true to make the analysis easier.</p></li>
</ul>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> service_type_cte <span class="kw">AS</span> (</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    id_key,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">WHEN</span> line <span class="kw">IN</span> (<span class="st">'R1'</span>, <span class="st">'R2'</span>, <span class="st">'R3'</span>, <span class="st">'R4'</span>, <span class="st">'R7'</span>, <span class="st">'R8'</span>, <span class="st">'RG1'</span>, <span class="st">'RT2'</span>) <span class="cf">THEN</span> <span class="st">'Commuter'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">ELSE</span> <span class="st">'Regional'</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> service_type</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> train_data</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    id_key,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    id_date,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    line,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    service_type,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    tech_id, </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    com_id,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    actual_origin_departure_time,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    actual_destination_arrival_time,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    last_stop_code,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">INITCAP</span>(station_name) <span class="kw">AS</span> last_stop_name,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    last_stop_delay,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">WHEN</span> last_stop_delay <span class="op">&gt;</span> <span class="dv">3</span> <span class="kw">AND</span> service_type <span class="op">=</span> <span class="st">'Commuter'</span> <span class="cf">THEN</span> <span class="kw">true</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">WHEN</span> last_stop_delay <span class="op">&gt;</span> <span class="dv">5</span> <span class="kw">AND</span> service_type <span class="op">=</span> <span class="st">'Regional'</span> <span class="cf">THEN</span> <span class="kw">true</span> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">ELSE</span> <span class="kw">false</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> is_delay,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">WHEN</span> is_disabled <span class="op">=</span> <span class="kw">false</span> <span class="kw">AND</span> is_cancelled <span class="op">=</span> <span class="kw">false</span> <span class="cf">THEN</span> <span class="kw">false</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">ELSE</span> <span class="kw">true</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> is_cancelled,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    is_pmr,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    data_timestamp,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    calendar_date,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">month</span>,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    week</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> basic_data</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> train_data </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> service_type_cte </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> stations </span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> train_data.last_stop_code <span class="op">=</span> stations.station_id</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="dt">date</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> train_data.id_date <span class="op">=</span> <span class="dt">date</span>.date_key</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> data_timestamp <span class="op">&lt;=</span> <span class="st">'2022-10-30 23:59:00'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This done, Iâ€™ve queried this table to obtain some basic general statistics on the data. As there seems to be negative delays at destination, some of them extreme and improbable (up to -1440 minutes), I also have calculated an extra measure named â€˜adjusted_delayâ€™ to verify the impact of this outliers over the data, as it can be seen below.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> adjusted_delay_cte <span class="kw">AS</span> (</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="dv">0</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> last_stop_delay</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> adjusted_delay</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  service_type,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(id_key) <span class="kw">AS</span> total_trains,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(last_stop_delay) <span class="kw">AS</span> min_delay,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(last_stop_delay) <span class="kw">AS</span> max_delay,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(adjusted_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay_adj,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_pmr:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_pmr</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> general_stats</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> adjusted_delay_cte <span class="kw">USING</span>(id_key)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> service_type;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As shown in the table, we seem to have almost 60,000 registries and some strange values when it comes to the lowest delays at the destination, something that should be revised on a later in-depth data cleaning.</p>
<p>From the calculated measures itâ€™s possible to infer that:</p>
<ul>
<li><p>Commuter trains tend to be more unpunctual in percentage, as 55.9% of them did not arrive on time at their destination, as opposed to 31.9% for regional trains. Additionally, commuter trains are more likely to be cancelled, even though the percentage of cancelled trains is very low.</p></li>
<li><p>Especially among commuter trains, and according to the median delay, its delay at the destination tends to be very close to the threshold to classify them as delayed at the destination. So most of those commuter trains classified as delayed are probably just slightly exceeding this threshold.</p></li>
<li><p>When it comes to the delay (in minutes) it doesnâ€™t seem to be big differences, as average and median delays are similar for commuter and regional trains.</p></li>
<li><p>Even though the abnormally low delay at destination appears to have some impact on aggregated data, the impact is minimal and therefore not very concerning at this stage.</p></li>
<li><p>Finally, most commuter trains (78.8%) are labelled as accessible for people with mobility issues, while only 30.5% regional trains are.</p></li>
</ul>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-39f0d1ac6ad8aa98be07" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-39f0d1ac6ad8aa98be07">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 1. Main indicators, split by service type<\/caption>","data":[["Commuter","Regional"],[50195,8511],[-1440,-130],[262,323],[7.5,7.1],[7.7,7.3],[4,3],[55.9,31.9],[0.4,0.2],[78.8,30.5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Service type<\/th>\n      <th>Total trains<\/th>\n      <th>Min delay<\/th>\n      <th>Max delay<\/th>\n      <th>Avg delay<\/th>\n      <th>Avg adjusted delay<\/th>\n      <th>Median delay<\/th>\n      <th>Pct delayed<\/th>\n      <th>Pct cancelled<\/th>\n      <th>Pct accessible<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="delays-distribution" class="level3">
<h3 class="anchored" data-anchor-id="delays-distribution">Delays distribution</h3>
<p>When looking at delays distribution is it possible to verify that most of these are minor delays, that is, that didnâ€™t arrive more than 5 minutes late at their destination. This way and according to this data, most commuter trains were punctual (19.6%) or experienced minor delays (37.5%), while about 23% of them experienced significant (11-15 minutes) or heavy delays (more than 15 minutes).</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> delay_category_cte <span class="kw">AS</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="cf">CASE</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="op">&lt;=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'1- Punctual'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">AND</span> <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'2- From 1 to 5 minutes'</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">6</span> <span class="kw">AND</span> <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'3- From 6 to 10 minutes'</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">11</span> <span class="kw">AND</span> <span class="dv">15</span> <span class="cf">THEN</span> <span class="st">'4- From 11 to 15 minutes'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'5- More than 15 minutes'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> delay_category</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  delay_category,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">COUNT</span>(delay_category) <span class="op">/</span> (( <span class="fu">SUM</span>(<span class="fu">COUNT</span>(<span class="op">*</span>)) <span class="kw">OVER</span>() )) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_count,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_distribution_commuter</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">LEFT</span> <span class="kw">JOIN</span> delay_category_cte</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span>(id_key)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Commuter'</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> delay_category</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> delay_category;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-e14c6398d6b353a39146" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e14c6398d6b353a39146">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 2. Commuter trains: Main indicators by delay category.<\/caption>","data":[["1- Punctual","2- From 1 to 5 minutes","3- From 6 to 10 minutes","4- From 11 to 15 minutes","5- More than 15 minutes"],[19.6,37.5,19.9,10.1,12.8],[1.5,0.1,0.1,0,0.3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>delay_category<\/th>\n      <th>pct_count<\/th>\n      <th>pct_cancelled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> delay_category_cte <span class="kw">AS</span> (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="op">&lt;=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'1- Punctual'</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">AND</span> <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'2- From 1 to 5 minutes'</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">6</span> <span class="kw">AND</span> <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'3- From 6 to 10 minutes'</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> last_stop_delay <span class="kw">BETWEEN</span> <span class="dv">11</span> <span class="kw">AND</span> <span class="dv">15</span> <span class="cf">THEN</span> <span class="st">'4- From 11 to 15 minutes'</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'5- More than 15 minutes'</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> delay_category</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  delay_category,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">COUNT</span>(delay_category) <span class="op">/</span> (( <span class="fu">SUM</span>(<span class="fu">COUNT</span>(<span class="op">*</span>)) <span class="kw">OVER</span>() )) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_count,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_distribution_regional</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">LEFT</span> <span class="kw">JOIN</span> delay_category_cte</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span>(id_key)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Regional'</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> delay_category</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> delay_category;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same can be said about regional trains, which generally perform slightly better. This way 68.1% of them are completely punctual, or they just suffered from minor delays, over the 16.1% of them that experienced significant or heavy delays at destination.</p>
<p>In addition, it is worth noting that most cancelled trains fall under the punctual category, regardless of whether they are classified as commuter trains or regional trains. This probably means that most cancelled trains did not even depart from the origin station.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-2e8fd9262e7a227c044a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2e8fd9262e7a227c044a">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 3. Regional trains: Main indicators by delay category.<\/caption>","data":[["1- Punctual","2- From 1 to 5 minutes","3- From 6 to 10 minutes","4- From 11 to 15 minutes","5- More than 15 minutes"],[23,45.1,15.8,5.8,10.3],[0.5,0.1,0.1,0,0.1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>delay_category<\/th>\n      <th>pct_count<\/th>\n      <th>pct_cancelled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="main-metrics-by-time-periods" class="level3">
<h3 class="anchored" data-anchor-id="main-metrics-by-time-periods">Main metrics by time periods</h3>
<section id="trend-by-week" class="level4">
<h4 class="anchored" data-anchor-id="trend-by-week">Trend by week</h4>
<p>Looking at the trend by week over the chosen metrics is it hard to spot any clear trend, despite it can be perceived a slight reduction on average delay at destination and on the percentage of delayed trains, both for commuter and regional trains.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">month</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  week,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(id_key) <span class="kw">AS</span> total_trains,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(last_stop_delay) <span class="kw">AS</span> min_delay,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(last_stop_delay) <span class="kw">AS</span> max_delay,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> general_stats_evolution_commuter</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Commuter'</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">month</span>, week</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> week;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-423fc599dbda64579d10" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-423fc599dbda64579d10">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 4. Commuter trains: Main indicators evolution.<\/caption>","data":[["August","August","August","September","September","September","September","October","September","October","October","October","October"],[33,34,35,35,36,37,38,39,39,40,41,42,43],[2430,4272,2119,2566,4789,4958,5415,1185,3891,3867,5092,4290,5321],[-1440,-24,-6,-48,-45,-4,-12,-9,-5,-30,-9,-6,-26],[259,205,262,179,244,159,173,68,128,87,59,67,243],[4,7,10.7,12.4,9.8,7.7,7.2,4.5,7.8,7.1,6.3,6.7,6.2],[3,4,5,6,5,5,5,3,4,5,4,4,4],[44.1,50.2,62.6,61.8,57.8,59.8,59.2,44.3,53.4,59.3,55.5,56.8,53.2],[0.2,0.2,1.1,1,0.5,0.5,0.1,0.1,0.2,0.3,0.5,0.3,0.3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Month<\/th>\n      <th>Week<\/th>\n      <th>Total trains<\/th>\n      <th>Min delay<\/th>\n      <th>Max delay<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n      <th>Pct delayed<\/th>\n      <th>Pct cancelled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">month</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  week,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(id_key) <span class="kw">AS</span> total_trains,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(last_stop_delay) <span class="kw">AS</span> min_delay,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(last_stop_delay) <span class="kw">AS</span> max_delay,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> general_stats_evolution_regional</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Regional'</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">month</span>, week</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> week;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-7d568f985a96e2abf3a5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7d568f985a96e2abf3a5">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 5. Regional trains: Main indicators evolution.<\/caption>","data":[["August","August","August","September","September","September","September","October","September","October","October","October","October"],[33,34,35,35,36,37,38,39,39,40,41,42,43],[457,850,346,460,839,846,893,217,609,640,832,683,839],[-6,-130,-4,-6,-9,-7,-12,-5,-3,-5,-3,-4,-7],[323,104,122,133,220,151,161,74,150,108,64,102,136],[7.2,3.5,8.7,8.3,11.3,8.6,8.2,5,7.5,5.6,5,6.5,6.6],[2,2,3,4,3,3,3,2,3,3,3,3,3],[25.8,22.4,34.7,39.3,37.3,36.3,34.7,28.1,31.9,33.1,30.4,30.9,29.6],[0,0,0.6,0,0.4,0.1,0,0,0.3,0.2,0.1,0.3,0.2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Month<\/th>\n      <th>Week<\/th>\n      <th>Total trains<\/th>\n      <th>Min delay<\/th>\n      <th>Max delay<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n      <th>Pct delayed<\/th>\n      <th>Pct cancelled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="trend-by-day-of-the-week" class="level4">
<h4 class="anchored" data-anchor-id="trend-by-day-of-the-week">Trend by day of the week</h4>
<p>Instead, when aggregating the data by day of the week, we see that trains that operate on weekdays tend to experience fewer delays. As shown in the table below, about 54-58% of the trains running on weekdays arrive late at their destination, compared to 37-41% of trains running on the weekend. This fact could be correlated with the traffic reduction that the railway network experiences on weekends, as also shown in the table.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  weekday,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay,   </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="dt">date</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> basic_data.id_date <span class="op">=</span> <span class="dt">date</span>.date_key</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> weekday</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pct_delayed <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>7 records</caption>
<colgroup>
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">weekday</th>
<th style="text-align: right;">total_trains</th>
<th style="text-align: right;">avg_delay</th>
<th style="text-align: right;">median_delay</th>
<th style="text-align: right;">pct_delayed</th>
<th style="text-align: right;">pct_cancelled</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Friday</td>
<td style="text-align: right;">9419</td>
<td style="text-align: right;">9.9</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">58.9</td>
<td style="text-align: right;">0.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">Thursday</td>
<td style="text-align: right;">8676</td>
<td style="text-align: right;">8.2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">57.1</td>
<td style="text-align: right;">0.3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Monday</td>
<td style="text-align: right;">8785</td>
<td style="text-align: right;">7.4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">56.8</td>
<td style="text-align: right;">0.3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tuesday</td>
<td style="text-align: right;">10215</td>
<td style="text-align: right;">7.1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">54.5</td>
<td style="text-align: right;">0.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wednesday</td>
<td style="text-align: right;">7898</td>
<td style="text-align: right;">8.3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">54.1</td>
<td style="text-align: right;">0.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Saturday</td>
<td style="text-align: right;">6816</td>
<td style="text-align: right;">5.3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">41.5</td>
<td style="text-align: right;">0.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sunday</td>
<td style="text-align: right;">6897</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">37.9</td>
<td style="text-align: right;">0.2</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="trend-by-hour-of-the-day" class="level4">
<h4 class="anchored" data-anchor-id="trend-by-hour-of-the-day">Trend by hour of the day</h4>
<p>In the same way, when analysing the data by hour of the day, grouped by trains departure hour from the origin, it can be spotted how delays are higher during rush hours, when most trains are running, especially between 7am-9am and 6pm-8pm.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EXTRACT</span>(<span class="kw">hour</span> <span class="kw">from</span> actual_origin_departure_time) <span class="kw">AS</span> day_hour,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_cancelled:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_cancelled</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> stats_by_hour</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> day_hour</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> day_hour;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-87cf95b2d099d57e00ae" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-87cf95b2d099d57e00ae">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 6. Delay metrics by train line<\/caption>","data":[[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],[422,2219,3626,4187,3447,3215,3079,3239,2990,3278,3424,3624,3555,3535,3896,3596,3215,2708,1139,312],[6.2,7.1,7.1,8.1,7.9,7.2,6.5,7,7.1,7.1,6.9,7.3,7.2,7.8,8.6,9.3,8.5,6.4,4.7,1.1],[3,3,4,5,5,4,4,4,4,3,4,4,4,4,5,5,5,3,2,0],[37.7,45.6,49.8,59.6,59,51.8,52.1,49.3,51,47.5,52.3,52.7,51.5,54.4,57,59.5,57.4,45.1,35.6,11.9],[1.2,0.2,0.3,0.5,0.1,0.4,0.3,0.2,0.2,0.4,0.6,0.4,0.4,0.5,0.6,0.3,0.3,0.2,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Day hour<\/th>\n      <th>Total trains<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n      <th>Pct delayed<\/th>\n      <th>Pct cancelled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[0,1,2,3,4,5]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="main-metrics-by-train-line" class="level3">
<h3 class="anchored" data-anchor-id="main-metrics-by-train-line">Main metrics by train line</h3>
<p>Focussing on the differences between train lines, it can be seen how commuter lines under-perform their regional peers on punctuality metrics. This way, of the 10 worst-performing lines, 8 are commuter lines. Moreover, only one commuter train (R2 line), but also the most important one by the number of trains, has less than 50% of their trains running late at their destination.</p>
<p>A deeper look at the data reveals an interesting fact: most best-performing regional lines, like the R16 and R14 lines, goes totally or partially by the so-called south corridor, which connects Barcelona with southern and west Catalonia. In fact, the R2 line, which was the best-performing commuter line, also partially runs through this corridor, while their northern counterparts tend to experience more delays.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    line,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    service_type,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(line) <span class="kw">AS</span> total_trains, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ROUND</span>((<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>), <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> stats_by_line</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> line, service_type</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> pct_delayed <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-6343c560acec87b06582" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6343c560acec87b06582">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 7. Delay metrics by train line<\/caption>","data":[["RT2","R4","R3","RG1","R7","R8","R1","R12","R13","R2","R11","MD","R17","R15","R14","R16"],["Commuter","Commuter","Commuter","Commuter","Commuter","Commuter","Commuter","Regional","Regional","Commuter","Regional","Regional","Regional","Regional","Regional","Regional"],[488,9308,4826,421,3401,2227,11587,423,419,17937,3056,556,588,1577,633,1259],[87.5,76.5,73.4,69.8,63.3,53.3,50.2,49.9,47.3,41.9,33.7,32.6,31.3,28.1,26.7,24]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Line<\/th>\n      <th>Service type<\/th>\n      <th>Total trains<\/th>\n      <th>Pct delayed<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="delay-by-journey-time" class="level3">
<h3 class="anchored" data-anchor-id="delay-by-journey-time">Delay by journey time</h3>
<p>As shown below, when calculating the journey time itâ€™s possible to observe some anomalous data, from extremely long journey times to negative values. As it happened before with some delay values, it is likely the existence of some inconsistencies on the scraped data, something which will be handled later when doing a proper deep data cleaning.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> journey_time_cte <span class="kw">AS</span> (</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> actual_destination_arrival_time <span class="op">-</span> actual_origin_departure_time) <span class="op">/</span> <span class="dv">60</span>) <span class="op">-</span> last_stop_delay <span class="kw">AS</span> journey_time <span class="co">--in minutes</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  service_type,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(journey_time) <span class="kw">AS</span> max_journey_time,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(journey_time) <span class="kw">AS</span> min_journey_time,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(journey_time)) <span class="kw">AS</span> avg_journey_time</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> journey_time_cte</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> service_type;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>2 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">service_type</th>
<th style="text-align: right;">max_journey_time</th>
<th style="text-align: right;">min_journey_time</th>
<th style="text-align: right;">avg_journey_time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Regional</td>
<td style="text-align: right;">656</td>
<td style="text-align: right;">-548</td>
<td style="text-align: right;">156</td>
</tr>
<tr class="even">
<td style="text-align: left;">Commuter</td>
<td style="text-align: right;">4308</td>
<td style="text-align: right;">-3072</td>
<td style="text-align: right;">76</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Aggregating delay measures by journey time shows that middle-range commuter and regional trains perform better than those that do shorter or longer journeys. This way, commuter trains with journey times compressed between 30 and 119 minutes (~2 hours) perform better, especially when compared with those that exceed those 2 hours journey times.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> journey_time_cte <span class="kw">AS</span> (</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> actual_destination_arrival_time <span class="op">-</span> actual_origin_departure_time) <span class="op">/</span> <span class="dv">60</span>) <span class="op">-</span> last_stop_delay <span class="kw">AS</span> journey_time <span class="co">--in minutes</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>journey_time_range_cte <span class="kw">AS</span> (</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="op">&lt;=</span> <span class="dv">29</span> <span class="cf">THEN</span> <span class="st">'1- From 0 to 29 minutes'</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">30</span> <span class="kw">AND</span> <span class="dv">59</span> <span class="cf">THEN</span> <span class="st">'2- From 30 to 59 minutes'</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">60</span> <span class="kw">AND</span> <span class="dv">119</span> <span class="cf">THEN</span> <span class="st">'3- From 60 to 119 minutes'</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">120</span> <span class="kw">AND</span> <span class="dv">179</span> <span class="cf">THEN</span> <span class="st">'4- From 120 to 179 minutes'</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'5- More than 180 minutes'</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> journey_time_range</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> journey_time_cte</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  journey_time_range,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_by_journey_time_commuter</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> journey_time_cte</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> journey_time_range_cte</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Commuter'</span> <span class="kw">AND</span> journey_time <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> journey_time_range</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> journey_time_range;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-838d9c3cad9d7cd60d4a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-838d9c3cad9d7cd60d4a">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 8. Commuter trains: Delay metrics by journey time<\/caption>","data":[["1- From 0 to 29 minutes","2- From 30 to 59 minutes","3- From 60 to 119 minutes","4- From 120 to 179 minutes","5- More than 180 minutes"],[4051,15400,23313,5724,1342],[58.5,44.9,56.3,78,72],[6.1,4.7,7.7,14.1,8.3],[4,3,4,11,8]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Journey time<\/th>\n      <th>Total trains<\/th>\n      <th>Pct delayed<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The same applies to regional trains. Those who fall inside the middle range, between 120 and 179 minutes (~3 hours), have significantly better performance on delay metrics than those who donâ€™t.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> journey_time_cte <span class="kw">AS</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> actual_destination_arrival_time <span class="op">-</span> actual_origin_departure_time) <span class="op">/</span> <span class="dv">60</span>) <span class="op">-</span> last_stop_delay <span class="kw">AS</span> journey_time <span class="co">--in minutes</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>journey_time_range_cte <span class="kw">AS</span> (</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="op">&lt;=</span> <span class="dv">59</span> <span class="cf">THEN</span> <span class="st">'1- From 0 to 59 minutes'</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">60</span> <span class="kw">AND</span> <span class="dv">119</span> <span class="cf">THEN</span> <span class="st">'2- From 60 to 119 minutes'</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">120</span> <span class="kw">AND</span> <span class="dv">179</span> <span class="cf">THEN</span> <span class="st">'3- From 120 to 179 minutes'</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> journey_time <span class="kw">BETWEEN</span> <span class="dv">180</span> <span class="kw">AND</span> <span class="dv">239</span> <span class="cf">THEN</span> <span class="st">'4- From 180 to 239 minutes'</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'5- More than 239 minutes'</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> journey_time_range</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> journey_time_cte</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  journey_time_range,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_by_journey_time_regional</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> journey_time_cte</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> journey_time_range_cte</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Regional'</span> <span class="kw">AND</span> journey_time <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> journey_time_range</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> journey_time_range;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-d6795d4b20a11d1e0826" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d6795d4b20a11d1e0826">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 9. Regional trains: Delay metrics by journey time<\/caption>","data":[["1- From 0 to 59 minutes","2- From 60 to 119 minutes","3- From 120 to 179 minutes","4- From 180 to 239 minutes","5- More than 239 minutes"],[163,2839,3385,1692,419],[55.8,34.5,26.7,33.8,39.4],[14.1,7.5,5.9,7.4,9.1],[8,3,2,3,4]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Journey time<\/th>\n      <th>Total trains<\/th>\n      <th>Pct delayed<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="delay-by-number-of-stops" class="level3">
<h3 class="anchored" data-anchor-id="delay-by-number-of-stops">Delay by number of stops</h3>
<p>Finally, in terms of the relationship between the number of stops made by a train and the delay measures, we can say that, for commuter trains, the more stops made, the longer the delays are and the higher the percentage of trains arriving late at their destinations is. This way, while 44-48% of those trains making less than 20 stops arrived late, with an average ~5 minutes delay, the figures for those exceeding this threshold increased up to 67-78% when it comes to the percentage of delayed trains, as well as doubling the average delay.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> stop_count_cte <span class="kw">AS</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="op">&lt;=</span> <span class="dv">9</span> <span class="cf">THEN</span> <span class="st">'1- Less than 10 stops'</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="kw">BETWEEN</span> <span class="dv">10</span> <span class="kw">AND</span> <span class="dv">19</span> <span class="cf">THEN</span> <span class="st">'2- From 10 to 19 stops'</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="kw">BETWEEN</span> <span class="dv">20</span> <span class="kw">AND</span> <span class="dv">30</span> <span class="cf">THEN</span> <span class="st">'3- From 20 to 29 stops'</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'4- More than 29 stops'</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> stops_num</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> schedule</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> basic_data.id_key <span class="op">=</span> schedule.train_id</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> id_key</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a> stops_num,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_by_stops_commuter</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> stop_count_cte</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Commuter'</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> stops_num</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> stops_num;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-3816c1c8fa85678179f7" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3816c1c8fa85678179f7">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 10. Commuter trains: Delay metrics by number of stops<\/caption>","data":[["1- Less than 10 stops","2- From 10 to 19 stops","3- From 20 to 29 stops","4- More than 29 stops"],[9321,19963,12401,8510],[47.5,43.9,66.5,77.8],[5.1,4.8,9.6,13.2],[3,3,6,10]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Number of stops<\/th>\n      <th>Total trains<\/th>\n      <th>Pct delayed<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>With regard to regional trains, despite this relationship doesnâ€™t come up to be as strong as it was with commuter trains, the trend is quite similar. Thus, whereas regional trains making less than 30 stops on average reached their destination late about 28-33% of the time with an average 6-7 minutes of delay, their counterparts that made more than 30 stops underperformed these metrics, as shown below.</p>
<div class="cell" data-connection="con">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> stop_count_cte <span class="kw">AS</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  id_key,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="op">&lt;=</span> <span class="dv">9</span> <span class="cf">THEN</span> <span class="st">'1- Less than 10 stops'</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="kw">BETWEEN</span> <span class="dv">10</span> <span class="kw">AND</span> <span class="dv">19</span> <span class="cf">THEN</span> <span class="st">'2- From 10 to 19 stops'</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">MAX</span>(stop_order) <span class="kw">BETWEEN</span> <span class="dv">20</span> <span class="kw">AND</span> <span class="dv">30</span> <span class="cf">THEN</span> <span class="st">'3- From 20 to 29 stops'</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'4- More than 29 stops'</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> stops_num</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> schedule</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> basic_data.id_key <span class="op">=</span> schedule.train_id</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> id_key</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a> stops_num,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_trains,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(is_delay:<span class="ch">:INT</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> pct_delayed,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(last_stop_delay), <span class="dv">1</span>) <span class="kw">AS</span> avg_delay,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_stop_delay) <span class="kw">AS</span> median_delay</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> delay_by_stops_regional</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> basic_data</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> stop_count_cte</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">USING</span>(id_key)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> service_type <span class="op">=</span> <span class="st">'Regional'</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> stops_num</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> stops_num;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-fc168673e62213db0983" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-fc168673e62213db0983">{"x":{"filter":"none","vertical":false,"caption":"<caption>Table 11. Regional trains: Delay metrics by number of stops<\/caption>","data":[["1- Less than 10 stops","2- From 10 to 19 stops","3- From 20 to 29 stops","4- More than 29 stops"],[1300,4161,1980,1070],[33.3,27.6,33.7,43.9],[7.4,6.3,7.4,9.4],[3,2,3,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Number of stops<\/th>\n      <th>Total trains<\/th>\n      <th>Pct delayed<\/th>\n      <th>Avg delay<\/th>\n      <th>Median delay<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>